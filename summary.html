<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weekly Summary</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="navbar">
    <div class="nav-left">
      <a href="index.html">Home</a>
      <a href="addRide.html">Add Ride</a>
      <a href="summary.html">Weekly Summary</a>
    </div>
    <div class="nav-right">
      <span id="welcomeMsg" style="color: white; margin-right: 20px;"></span>
      <div class="profile-icon" onclick="toggleProfileMenu()">
        <span id="profileInitials"></span>
        <div id="profileMenu" class="dropdown-content">
          <a href="#" onclick="logout()">Logout</a>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <h2>Weekly Summary</h2>
    <div class="form-group">
      <label>Filter by Date:</label><br>
      <input type="date" id="startDate"> to
      <input type="date" id="endDate">
      <button class="btn" onclick="filterRides()">Apply</button>
      <button class="btn" onclick="clearTable()">Clear Table</button>
    </div>

    <table class="summary-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Date</th>
          <th>Location</th>
          <th>Trip Type</th>
          <th>Fare ($)</th>
          <th>Car (To)</th>
          <th>Car (Return)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="summaryBody"></tbody>
    </table>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="app.js"></script>
  <script>
    let allRides = [];

    firebase.database().ref("rides").on("value", snapshot => {
      const summaryBody = document.getElementById("summaryBody");
      summaryBody.innerHTML = "";
      allRides = [];
      snapshot.forEach(child => {
        const key = child.key;
        const ride = child.val();
        allRides.push({ ...ride, key });
        addRow(ride, key);
      });
    });

    function addRow(ride, key) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${ride.name}</td>
        <td>${formatDate(ride.date)}</td>
        <td>${ride.location}</td>
        <td>${ride.tripType}</td>
        <td>$${ride.fare}</td>
        <td>${ride.carTo || "-"}</td>
        <td>${ride.carReturn || "-"}</td>
        <td>
          <button class="btn-sm" onclick="editRide('${key}')">‚úèÔ∏è</button>
          <button class="btn-sm btn-danger" onclick="deleteRide('${key}')">üóëÔ∏è</button>
        </td>
      `;
      document.getElementById("summaryBody").appendChild(row);
    }

    function formatDate(dateStr) {
      const [year, month, day] = dateStr.split("-");
      return `${month}/${day}/${year}`;
    }

    function filterRides() {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      const summaryBody = document.getElementById("summaryBody");
      summaryBody.innerHTML = "";
      allRides
        .filter(ride => ride.date >= start && ride.date <= end)
        .forEach(ride => addRow(ride, ride.key));
    }

    function clearTable() {
      document.getElementById("startDate").value = "";
      document.getElementById("endDate").value = "";
      const summaryBody = document.getElementById("summaryBody");
      summaryBody.innerHTML = "";
      allRides.forEach(ride => addRow(ride, ride.key));
    }

    function deleteRide(rideKey) {
      if (confirm("Are you sure you want to delete this ride?")) {
        firebase.database().ref("rides/" + rideKey).remove()
          .then(() => {
            alert("Ride deleted.");
          })
          .catch(err => {
            alert("Error deleting ride: " + err.message);
          });
      }
    }

    function editRide(rideKey) {
      firebase.database().ref("rides/" + rideKey).once("value").then(snapshot => {
        const ride = snapshot.val();
        const updatedFare = prompt("Update Fare ($):", ride.fare);
        if (updatedFare !== null) {
          firebase.database().ref("rides/" + rideKey).update({
            fare: parseFloat(updatedFare)
          }).then(() => {
            alert("Ride updated.");
          });
        }
      });
    }

    window.onload = function () {
      const initials = localStorage.getItem("userInitials");
      const firstName = localStorage.getItem("firstName");
      if (initials) {
        document.getElementById("profileInitials").innerText = initials;
      }
      if (firstName) {
        document.getElementById("welcomeMsg").innerText = "Welcome, " + firstName;
      }
    };

    function toggleProfileMenu() {
      const menu = document.getElementById("profileMenu");
      menu.style.display = menu.style.display === "block" ? "none" : "block";
    }
  </script>
</body>
</html>
