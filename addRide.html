<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Ride</title>
  <script>
    const user = localStorage.getItem("firstName");
    if (!user) {
      window.location.href = "login.html";
    }
  </script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="navbar">
    <div class="nav-left">
      <a href="index.html">Home</a>
      <a href="addRide.html" class="active">Add Ride</a>
      <a href="summary.html">Weekly Summary</a>
      <a href="profileSummary.html">Profile Summary</a>
    </div>
    <div class="nav-right">
      <span id="welcomeMsg" style="color: white; margin-right: 20px;"></span>
      <div class="profile-icon" onclick="toggleProfileMenu()">
        <span id="profileInitials"></span>
        <div id="profileMenu" class="dropdown-content">
          <a href="#" onclick="logout()">Logout</a>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <h2>Add a Ride</h2>

    <div id="addPersonSection" style="display: none;" class="form-group">
      <label for="newPerson">Add New Person:</label>
      <input type="text" id="newPerson" placeholder="Enter name">
      <button type="button" class="btn" onclick="addPerson()">Add</button>
    </div>

    <form id="rideForm">
      <div class="form-group">
        <label for="name">Name:</label>
        <select id="name" required>
          <option value="">--Select Person--</option>
        </select>
      </div>

      <div class="form-group">
        <label for="date">Date:</label>
        <input type="date" id="date" required>
      </div>

      <div class="form-group">
        <label for="location">Location:</label>
        <select id="location" required>
          <option value="">--Select Location--</option>
          <option value="Mills">Mills</option>
          <option value="Motel">Motel</option>
        </select>
      </div>

      <div class="form-group">
        <label for="tripType">Trip Type:</label>
        <select id="tripType" required>
          <option value="">--Select Trip Type--</option>
          <option value="One-way">One-way</option>
          <option value="Round-trip">Round-trip</option>
        </select>
      </div>

      <div class="form-group">
        <label for="carTo">Car (To):</label>
        <select id="carTo" required>
          <option value="">--Select Car--</option>
          <option value="Nissan">Nissan</option>
          <option value="Hybrid">Hybrid</option>
          <option value="Honda">Honda</option>
          <option value="Ford">Ford</option>
        </select>
      </div>

      <div class="form-group">
        <label for="carReturn">Car (Return):</label>
        <select id="carReturn">
          <option value="">--Select Car--</option>
          <option value="Nissan">Nissan</option>
          <option value="Hybrid">Hybrid</option>
          <option value="Honda">Honda</option>
          <option value="Ford">Ford</option>
        </select>
      </div>

      <button type="submit" class="btn">Submit Ride</button>
    </form>

    <div id="result"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="app.js"></script>
  <script>
    function toggleProfileMenu() {
      const menu = document.getElementById("profileMenu");
      menu.style.display = menu.style.display === "block" ? "none" : "block";
    }

    function loadMembers() {
      const nameSelect = document.getElementById("name");
      nameSelect.innerHTML = '<option value="">--Select Person--</option>';
      firebase.database().ref("members").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const option = document.createElement("option");
          option.value = child.val();
          option.textContent = child.val();
          nameSelect.appendChild(option);
        });
      });
    }

    function addPerson() {
      const newPersonInput = document.getElementById("newPerson");
      const newName = newPersonInput.value.trim();

      if (!newName) {
        alert("Please enter a name.");
        return;
      }

      firebase.database().ref("members").once("value").then(snapshot => {
        let exists = false;
        snapshot.forEach(child => {
          if (child.val().toLowerCase() === newName.toLowerCase()) {
            exists = true;
          }
        });

        if (exists) {
          alert("This name already exists.");
        } else {
          firebase.database().ref("members").push(newName).then(() => {
            newPersonInput.value = "";
            loadMembers(); // refresh the dropdown
          });
        }
      });
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        localStorage.clear();
        window.location.href = "login.html";
      });
    }

    window.onload = function () {
      const initials = localStorage.getItem("userInitials");
      const firstName = localStorage.getItem("firstName");
      const isAdmin = localStorage.getItem("isAdmin");

      if (initials) document.getElementById("profileInitials").innerText = initials;
      if (firstName) document.getElementById("welcomeMsg").innerText = "Welcome, " + firstName;
      if (isAdmin === "true") {
        document.getElementById("addPersonSection").style.display = "block";
      }

      loadMembers();
    };

    
document.getElementById("rideForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const name = document.getElementById("name").value;
  const date = document.getElementById("date").value;
  const location = document.getElementById("location").value;
  const tripType = document.getElementById("tripType").value;
  const carTo = document.getElementById("carTo").value;
  const carReturn = document.getElementById("carReturn").value;

  let baseFare = 0;
  if (location === "Mills" && tripType === "Round-trip") {
    baseFare = 15; // Total car fare to split
  } else if (location === "Mills") {
    baseFare = 4; // One-way base
  } else if (location === "Motel" && tripType === "Round-trip") {
    baseFare = 10;
  } else if (location === "Motel") {
    baseFare = 5;
  }

  const newRide = { name, date, location, tripType, carTo, carReturn, fare: baseFare };

  if (location === "Mills" && tripType === "Round-trip") {
    calculateSharedFareAndSaveRide(newRide); // New logic
  } else {
    firebase.database().ref("rides").push(newRide).then(() => {
      document.getElementById("result").innerText = "✅ Ride added successfully!";
      document.getElementById("rideForm").reset();
    }).catch(err => {
      document.getElementById("result").innerText = "❌ Error: " + err.message;
    });
  }
});

  </script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-X6CGLDGYEZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-X6CGLDGYEZ');
  </script>
</body>
</html>
